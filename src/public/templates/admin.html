<section class="panel">
  <p class="eyebrow">Admin</p>
  <h2>Circle settings and policy</h2>
  <p>Configure how this node enforces wallet verification, circle alignment, and peer aggregation.</p>
  <div class="callout">
    <p class="muted small">Circle name: {{circleName}}</p>
    <p class="muted small">Policy ID: {{policyId}} v{{policyVersion}}</p>
    <p class="muted small">Posting gate: {{postingGate}}</p>
    <p class="muted small">Ledger entries: {{ledgerEntries}} Â· Peers: {{peersKnown}}</p>
    <p class="muted small">Ledger hash: {{ledgerHash}}</p>
    <p class="muted small">Data: {{dataProfile}}</p>
    <p class="muted small">Gossip ingest: {{gossipIngest}}</p>
    <p class="muted small">Extensions: {{extensionsSummary}}</p>
    <p class="muted small">{{modulesSummary}}</p>
    <p class="muted small">Initialized: {{initialized}}</p>
    <p class="muted small">{{notes}}</p>
    <p class="muted small">{{firstRunNote}}</p>
  </div>
  <p class="muted small">{{flash}}</p>
  <form class="stack" method="post" action="/admin" data-enhance="admin">
    <div class="form-grid">
      <label class="field">
        <span>Circle name</span>
        <input name="circleName" value="{{circleName}}" placeholder="Party Circle" />
      </label>
      <label class="field">
        <span>Policy ID</span>
        <input name="policyId" value="{{policyId}}" placeholder="party-circle-alpha" />
      </label>
    </div>
    <div class="form-grid">
      <label class="field checkbox">
        <input type="checkbox" name="enforceCircle" {{enforceCircleChecked}} />
        <span>Enforce Circle (verification before posting/voting)</span>
      </label>
      <label class="field checkbox">
        <input type="checkbox" name="requireVerification" {{requireVerificationChecked}} />
        <span>Require wallet verification for posting</span>
      </label>
    </div>
    <div class="form-grid">
      <label class="field">
        <span>Data mode</span>
        <select name="dataMode">
          <option value="centralized" {{dataModeCentralized}}>centralized</option>
          <option value="hybrid" {{dataModeHybrid}}>hybrid</option>
          <option value="p2p" {{dataModeP2P}}>p2p</option>
        </select>
      </label>
      <label class="field">
        <span>Validation level</span>
        <select name="dataValidation">
          <option value="strict" {{dataValidationStrict}}>strict</option>
          <option value="observe" {{dataValidationObserve}}>observe</option>
          <option value="off" {{dataValidationOff}}>off</option>
        </select>
      </label>
    </div>
    <div class="form-grid">
      <label class="field">
        <span>Data adapter</span>
        <select name="dataAdapter">
          <option value="json" {{dataAdapterJson}}>json (default)</option>
          <option value="memory" {{dataAdapterMemory}}>memory (ephemeral)</option>
          <option value="sql" {{dataAdapterSql}}>sql (sqlite3 optional dep)</option>
          <option value="kv" {{dataAdapterKv}}>kv (file-based)</option>
        </select>
      </label>
      <label class="field checkbox">
        <input type="checkbox" name="dataPreview" {{dataPreviewChecked}} />
        <span>Allow preview data (store uncertified entries)</span>
      </label>
    </div>
    <div class="form-grid">
      <label class="field">
        <span>Admin contact</span>
        <input name="adminContact" value="{{adminContact}}" placeholder="admin@example.org" />
      </label>
      <label class="field">
        <span>Preferred peer (Circle anchor)</span>
        <input name="preferredPeer" value="{{preferredPeer}}" placeholder="https://peer.party" />
      </label>
    </div>
    <div class="form-grid">
      <label class="field">
        <span>Default group election mode</span>
        <select name="defaultElectionMode">
          <option value="priority" {{defaultElectionModePriority}}>Priority</option>
          <option value="vote" {{defaultElectionModeVote}}>Vote</option>
        </select>
      </label>
      <label class="field">
        <span>Default group conflict rule</span>
        <select name="defaultConflictRule">
          <option value="highest_priority" {{defaultConflictHighest}}>Highest priority</option>
          <option value="prompt_user" {{defaultConflictPrompt}}>Prompt user</option>
        </select>
      </label>
    </div>
    <div class="form-grid">
      <label class="field">
        <span>Quorum advance stage (proposals)</span>
        <select name="petitionQuorumAdvance">
          <option value="discussion" {{petitionQuorumAdvanceDiscussion}}>discussion</option>
          <option value="vote" {{petitionQuorumAdvanceVote}}>vote</option>
        </select>
      </label>
      <div class="stack">
        <p class="muted small">Choose whether quorum moves proposals into discussion or directly into the vote stage.</p>
      </div>
    </div>
    <div class="form-grid">
      <label class="field">
        <span>Topic gardener URL (optional)</span>
        <input name="topicGardenerUrl" value="{{topicGardenerUrl}}" placeholder="http://localhost:8070/classify" />
      </label>
      <label class="field">
        <span>Topic anchors (comma separated)</span>
        <input name="topicAnchors" value="{{topicAnchors}}" placeholder="general,governance,economy" />
      </label>
    </div>
    <label class="field">
      <span>Pinned topics (comma separated)</span>
      <input name="topicPinned" value="{{topicPinned}}" placeholder="climate,health,education" />
    </label>
    <p class="muted small">Anchors and pins guide the topic gardener to reconcile provider labels.</p>
    <label class="field">
      <span>Notes</span>
      <textarea name="notes" rows="3" placeholder="Document circle intent or shared policy">{{notes}}</textarea>
    </label>
    <div class="form-grid">
      <label class="field">
        <span>Add peer and aggregate</span>
        <input name="peerJoin" placeholder="https://peer.party" />
      </label>
      <div class="stack">
        <p class="muted small">Add a trusted peer to sync ledger/policies. This will persist to the peer registry.</p>
      </div>
    </div>
    <div class="cta-row">
      <button class="cta" type="submit">Save settings</button>
      <a class="ghost" href="/" data-partial>Back home</a>
    </div>
    <p class="muted small">First installation hint: toggle enforcement + add a peer to align with a Circle. Settings persist to <code>src/data/settings.json</code>.</p>
  </form>
</section>

<section class="panel">
  <p class="eyebrow">Federation</p>
  <h2>Outbound gossip</h2>
  <p class="muted small">Push ledger and vote envelopes to peers on a schedule or manually.</p>
  <div class="stack">
    {{gossipSummary}}
    {{gossipPeers}}
  </div>
  <form class="stack" method="post" action="/admin" data-enhance="admin">
    <input type="hidden" name="intent" value="gossip-push" />
    <div class="cta-row">
      <button class="cta" type="submit">Push gossip now</button>
      <p class="muted small">Skips when data mode is centralized or no peers are registered.</p>
    </div>
  </form>
</section>

<section class="panel">
  <p class="eyebrow">Modules</p>
  <h2>Core feature toggles</h2>
  <p class="muted small">Disable optional modules for messaging-only deployments.</p>
  <form class="stack" method="post" action="/admin" data-enhance="admin">
    <input type="hidden" name="intent" value="modules" />
    <div class="form-grid">{{modulesList}}</div>
    <div class="cta-row">
      <button class="cta" type="submit">Save module toggles</button>
    </div>
    <p class="muted small">Reload to refresh navigation after changing modules.</p>
  </form>
</section>

<section class="panel">
  <p class="eyebrow">Structure manager</p>
  <h2>Profile schema (canonical + provider-local)</h2>
  <p class="muted small">Canonical fields: {{canonicalProfileSummary}}. Provider-local fields never gossip and fuel provider-owned notifications/consent.</p>
  <form class="stack" method="post" action="/admin" data-enhance="admin">
    <input type="hidden" name="intent" value="structure" />
    <label class="field">
      <span>Provider-local fields (one per line: key:type:label, add ! for required)</span>
      <textarea name="providerFields" rows="4" placeholder="email:email:Contact email">{{providerFieldsValue}}</textarea>
    </label>
    <p class="muted small">Example: <code>email:email:Contact email</code>. Allowed types: string, email, phone, boolean, number. Canonical fields stay fixed across the party ring (handle, credential/wallet binding, blinded hash, role, banned).</p>
    <div class="cta-row">
      <button class="cta" type="submit">Save provider schema</button>
      <span class="muted small">Fields saved: {{providerFieldCount}}</span>
    </div>
  </form>
</section>

<section class="panel">
  <p class="eyebrow">Provider profile data</p>
  <h2>Contact/notification attributes</h2>
  <p class="muted small">Persist provider-local profile values for a session/handle (email, notification prefs). Values stay local; provider owns delivery/consent.</p>
  <form class="stack" method="post" action="/admin" data-enhance="admin">
    <input type="hidden" name="intent" value="profile-attributes" />
    <div class="form-grid">
      <label class="field">
        <span>Session ID</span>
        <input name="attributesSessionId" value="{{attributesSessionId}}" placeholder="copy from /health or logs" />
      </label>
    </div>
    <label class="field">
      <span>Provider attributes (JSON object or key:value per line)</span>
      <textarea name="attributesPayload" rows="4" placeholder="email: user@example.org&#10;notify: true">{{attributesPayloadValue}}</textarea>
    </label>
    <p class="muted small">Only fields defined in your provider schema are stored. Canonical fields remain fixed and shared across the party ring.</p>
    <div class="cta-row">
      <button class="cta" type="submit">Save provider attributes</button>
    </div>
  </form>
</section>

<section class="panel">
  <p class="eyebrow">Admin audit</p>
  <h2>Recent configuration changes</h2>
  <p class="muted small">Last 10 actions are listed; older entries roll off for privacy. Includes schema and profile updates.</p>
  <div class="stack">
    {{auditLog}}
  </div>
</section>

<section class="panel">
  <p class="eyebrow">Transactions</p>
  <h2>Recent ledgered actions</h2>
  <p class="muted small">Append-only log for sensitive actions (petitions, votes, delegations, social, groups). Export JSON for audits.</p>
  <div class="stack">
    {{transactionsList}}
  </div>
  <div class="cta-row">
    <a class="ghost" href="/transactions" target="_blank" rel="noreferrer">Open JSON log</a>
    <a class="ghost" href="/transactions/export" target="_blank" rel="noreferrer">Export signed summary</a>
  </div>
</section>

<section class="panel">
  <p class="eyebrow">Extensions</p>
  <h2>Toggle extensions</h2>
  <p class="muted small">Enable/disable extensions at runtime (persists to settings).</p>
  <form class="stack" method="post" action="/extensions" data-enhance="extensions">
    <div class="form-grid">{{extensionsList}}</div>
    <div class="cta-row">
      <button class="cta" type="submit">Apply extensions</button>
    </div>
    <p class="muted small">POSTs to /extensions; reload applies hooks immediately.</p>
  </form>
</section>

<section class="panel">
  <p class="eyebrow">Session overrides</p>
  <h2>Roles and bans</h2>
  <p class="muted small">Update a session role/handle or ban a handle to exercise Circle gates without editing JSON manually.</p>
  <form class="stack" method="post" action="/admin" data-enhance="admin">
    <input type="hidden" name="intent" value="session" />
    <div class="form-grid">
      <label class="field">
        <span>Session ID</span>
        <input name="sessionId" value="{{sessionIdValue}}" placeholder="copy from /health or logs" required />
      </label>
      <label class="field">
        <span>Handle override (optional)</span>
        <input name="sessionHandle" value="{{sessionHandleValue}}" placeholder="person-abcd1234" />
      </label>
    </div>
    <div class="form-grid">
      <label class="field">
        <span>Role</span>
        <select name="sessionRole">
          <option value="person" {{sessionRolePerson}}>person</option>
          <option value="delegate" {{sessionRoleDelegate}}>delegate</option>
          <option value="moderator" {{sessionRoleModerator}}>moderator</option>
          <option value="admin" {{sessionRoleAdmin}}>admin</option>
        </select>
      </label>
      <label class="field checkbox">
        <input type="checkbox" name="sessionBanned" {{sessionBannedChecked}} />
        <span>Ban this handle/session</span>
      </label>
    </div>
    <div class="cta-row">
      <button class="cta" type="submit">Update session</button>
      <a class="ghost" href="/health" target="_blank" rel="noreferrer">Open /health to fetch session IDs</a>
    </div>
    <p class="muted small">Changes persist to <code>src/data/sessions.json</code> and are used by Circle gates immediately.</p>
  </form>
</section>
